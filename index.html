<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OTM 300 Calculators</title>

  <!-- Optional metadata (nice to have, not required) -->
  <meta name="copyright" content="© 2025 Amir. All rights reserved.">
  <meta name="description" content="OTM 300 Exam Calculators (Little's Law and basic arithmetic).">

  <style>
    body { font-family: Arial, sans-serif; margin: 24px; line-height: 1.35; }
    .container { max-width: 900px; margin: 0 auto; }
    h1 { margin-bottom: 8px; }
    .note { color: #444; margin-top: 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { display: block; font-weight: 600; margin-bottom: 4px; }
    input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
    button { padding: 10px 14px; border: 1px solid #aaa; border-radius: 8px; background: #f7f7f7; cursor: pointer; font-size: 16px; }
    button:hover { background: #eee; }
    .row { display: flex; gap: 10px; align-items: end; flex-wrap: wrap; }
    .result { font-size: 18px; font-weight: 700; padding: 10px; background: #fafafa; border: 1px dashed #bbb; border-radius: 8px; }
    .small { font-size: 13px; color: #555; }

    details.calc {
      border: 1px solid #ddd;
      border-radius: 10px;
      margin: 12px 0;
      background: #fff;
    }

    details.calc > summary {
      padding: 14px 16px;
      cursor: pointer;
      font-weight: 700;
      list-style: none;
      user-select: none;
    }

    details.calc > summary::-webkit-details-marker { display: none; }

    details.calc > summary::before {
      content: "▶";
      display: inline-block;
      width: 22px;
      margin-right: 6px;
      transform: translateY(-1px);
    }

    details.calc[open] > summary::before { content: "▼"; }

    details.calc .content { padding: 0 16px 16px 16px; }

    .section-title { margin: 12px 0 6px 0; }

    .input-with-unit {
      display: grid;
      grid-template-columns: 1fr 180px;
      gap: 10px;
      align-items: end;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    .footer {
      margin-top: 22px;
      padding-top: 12px;
      border-top: 1px solid #eee;
      color: #666;
      font-size: 12px;
      line-height: 1.4;
    }

    @media (max-width: 700px) {
      .grid { grid-template-columns: 1fr; }
      .input-with-unit { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>OTM 300 Calculators</h1>
    <p class="note">This page does not store data. Refreshing resets values.</p>

    <div class="row" style="margin: 12px 0 18px 0;">
      <button type="button" onclick="openAll()">Expand all</button>
      <button type="button" onclick="closeAll()">Collapse all</button>
      <button type="button" onclick="resetAll()">Reset all</button>
    </div>

    <!-- Replaces your old Simple Calculator with an exam-safe general calculator -->
    <details class="calc" open>
      <summary>General Calculator (Exam-Safe)</summary>
      <div class="content">
        <p class="small">Basic arithmetic only: + − × ÷, parentheses, decimals.</p>

        <div style="max-width: 520px;">
          <label for="expr">Expression</label>
          <input id="expr" type="text" inputmode="decimal" placeholder="e.g., (12.5 + 3) / 4" />

          <div class="row" style="margin-top: 10px;">
            <button type="button" onclick="appendExpr('(')">(</button>
            <button type="button" onclick="appendExpr(')')">)</button>
            <button type="button" onclick="appendExpr('%')">%</button>
            <button type="button" onclick="backspaceExpr()">⌫</button>
            <button type="button" onclick="clearExpr()">AC</button>
          </div>

          <div class="grid" style="margin-top: 10px; grid-template-columns: repeat(4, 1fr);">
            <button type="button" onclick="appendExpr('7')">7</button>
            <button type="button" onclick="appendExpr('8')">8</button>
            <button type="button" onclick="appendExpr('9')">9</button>
            <button type="button" onclick="appendExpr('/')">÷</button>

            <button type="button" onclick="appendExpr('4')">4</button>
            <button type="button" onclick="appendExpr('5')">5</button>
            <button type="button" onclick="appendExpr('6')">6</button>
            <button type="button" onclick="appendExpr('*')">×</button>

            <button type="button" onclick="appendExpr('1')">1</button>
            <button type="button" onclick="appendExpr('2')">2</button>
            <button type="button" onclick="appendExpr('3')">3</button>
            <button type="button" onclick="appendExpr('-')">−</button>

            <button type="button" onclick="appendExpr('0')">0</button>
            <button type="button" onclick="appendExpr('.')">.</button>
            <button type="button" onclick="computeExpr()" style="font-weight:700;">=</button>
            <button type="button" onclick="appendExpr('+')">+</button>
          </div>

          <div style="margin-top: 12px;">
            <div class="small">Result</div>
            <div class="result" id="exprResult">-</div>
          </div>

          <p class="small" style="margin-top: 10px;">Tip: You can also type directly and press Enter.</p>
        </div>
      </div>
    </details>

    <details class="calc">
      <summary>2. Intro to Operations</summary>
      <div class="content">
        <h3 class="section-title">Little’s Law</h3>

        <p class="small">
          Formula: <strong class="mono">I = R × T</strong>,
          where <strong>I</strong> is average inventory (flow units),
          <strong>R</strong> is average flow rate (flow units per time),
          and <strong>T</strong> is average flow time (time).
          Little’s Law describes <em>average</em> values.
        </p>

        <div class="row">
          <div style="flex: 1; min-width: 320px;">
            <label for="modeLittle">What do you want to solve for?</label>
            <select id="modeLittle" onchange="updateLittleUI()">
              <option value="solveI">Solve for I (given R and T)</option>
              <option value="solveT">Solve for T (given I and R)</option>
              <option value="solveR">Solve for R (given I and T)</option>
            </select>
          </div>

          <div style="flex: 1; min-width: 220px;">
            <label for="roundLittle">Rounding</label>
            <select id="roundLittle">
              <option value="none">No rounding</option>
              <option value="2">Round to 2 decimals</option>
              <option value="3">Round to 3 decimals</option>
              <option value="0">Round to whole number</option>
            </select>
          </div>

          <div id="outUnitWrap" style="flex: 1; min-width: 240px; display:none;">
            <label id="outUnitLabel" for="outUnit">Output units</label>
            <select id="outUnit"></select>
          </div>
        </div>

        <div class="grid" style="margin-top: 12px;">
          <div>
            <div class="input-with-unit">
              <div>
                <label id="xLabel" for="xInput">Flow rate, R</label>
                <input id="xInput" type="number" step="any" placeholder="e.g., 4">
              </div>
              <div>
                <label id="xUnitLabel" for="xUnit">Units</label>
                <select id="xUnit"></select>
              </div>
            </div>
          </div>

          <div>
            <div class="input-with-unit">
              <div>
                <label id="yLabel" for="yInput">Flow time, T</label>
                <input id="yInput" type="number" step="any" placeholder="e.g., 30">
              </div>
              <div>
                <label id="yUnitLabel" for="yUnit">Units</label>
                <select id="yUnit"></select>
              </div>
            </div>
          </div>
        </div>

        <div class="row" style="margin-top: 12px;">
          <button type="button" onclick="runLittle()">Compute</button>
          <button type="button" onclick="resetLittle()">Reset</button>
        </div>

        <div style="margin-top: 12px;">
          <div class="small">Result</div>
          <div class="result" id="littleResult">-</div>
          <div class="small" id="littleConversions" style="margin-top: 6px;"></div>
        </div>

        <p class="small" style="margin-top: 10px;">
          Tip: Use the unit dropdowns so the calculator handles time conversions.
        </p>
      </div>
    </details>

    <!-- NEW: Chapter 3 -->
    <details class="calc">
      <summary>3. Process Analysis</summary>
      <div class="content">

        <p class="small">
          Calculations only. The calculator converts to base units internally and then displays results in your chosen output units.
        </p>

        <div class="row">
          <div style="flex: 1; min-width: 220px;">
            <label for="roundCh3">Rounding</label>
            <select id="roundCh3">
              <option value="none">No rounding</option>
              <option value="2">Round to 2 decimals</option>
              <option value="3">Round to 3 decimals</option>
              <option value="0">Round to whole number</option>
            </select>
          </div>

          <div style="flex: 1; min-width: 260px;">
            <label for="outRateUnitCh3">Output capacity / flow-rate units</label>
            <select id="outRateUnitCh3">
              <option value="per minute">flow units per minute</option>
              <option value="per hour" selected>flow units per hour</option>
              <option value="per day">flow units per day</option>
            </select>
          </div>

          <div style="flex: 1; min-width: 240px;">
            <label for="outTimeUnitCh3">Output cycle-time units</label>
            <select id="outTimeUnitCh3">
              <option value="seconds">seconds</option>
              <option value="minutes" selected>minutes</option>
              <option value="hours">hours</option>
              <option value="days">days</option>
            </select>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid #eee; margin: 14px 0;" />

        <h3 class="section-title">Single-Step</h3>

        <div class="grid">
          <div>
            <label>Processing time (time per unit)</label>
            <div class="input-with-unit">
              <input id="pt1" type="number" step="any" placeholder="e.g., 2.5">
              <select id="pt1Unit">
                <option value="seconds">seconds / unit</option>
                <option value="minutes" selected>minutes / unit</option>
                <option value="hours">hours / unit</option>
                <option value="days">days / unit</option>
              </select>
            </div>
          </div>

          <div>
            <label>Parallel servers (m)</label>
            <input id="m1" type="number" step="1" min="0" placeholder="e.g., 1" value="1">
            <div class="small">If unsure, leave as 1.</div>
          </div>
        </div>

        <div class="grid" style="margin-top: 12px;">
          <div>
            <label>Demand rate</label>
            <div class="input-with-unit">
              <input id="demand1" type="number" step="any" placeholder="e.g., 30">
              <select id="demand1Unit">
                <option value="per minute">flow units / minute</option>
                <option value="per hour" selected>flow units / hour</option>
                <option value="per day">flow units / day</option>
              </select>
            </div>
          </div>

          <div>
            <label>&nbsp;</label>
            <div class="row">
              <button type="button" onclick="runCh3Single()">Compute</button>
              <button type="button" onclick="resetCh3()">Reset</button>
            </div>
          </div>
        </div>

        <div style="margin-top: 12px;">
          <div class="small">Result</div>
          <div class="result" id="ch3SingleResult">-</div>
          <div class="small" id="ch3SingleConversions" style="margin-top:6px;"></div>
        </div>

        <hr style="border:none;border-top:1px solid #eee; margin: 18px 0;" />

        <h3 class="section-title">Multi-Step (up to 4 steps)</h3>
        <p class="small">Enter the steps you have. Leave unused steps blank.</p>

        <div class="grid">
          <div>
            <label>Step 1 processing time</label>
            <div class="input-with-unit">
              <input id="ptS1" type="number" step="any" placeholder="e.g., 2">
              <select id="ptS1Unit">
                <option value="seconds">seconds / unit</option>
                <option value="minutes" selected>minutes / unit</option>
                <option value="hours">hours / unit</option>
                <option value="days">days / unit</option>
              </select>
            </div>
            <div style="margin-top:8px;">
              <label for="mS1">Step 1 servers (m)</label>
              <input id="mS1" type="number" step="1" min="0" value="1">
            </div>
          </div>

          <div>
            <label>Step 2 processing time</label>
            <div class="input-with-unit">
              <input id="ptS2" type="number" step="any" placeholder="e.g., 3">
              <select id="ptS2Unit">
                <option value="seconds">seconds / unit</option>
                <option value="minutes" selected>minutes / unit</option>
                <option value="hours">hours / unit</option>
                <option value="days">days / unit</option>
              </select>
            </div>
            <div style="margin-top:8px;">
              <label for="mS2">Step 2 servers (m)</label>
              <input id="mS2" type="number" step="1" min="0" value="1">
            </div>
          </div>

          <div>
            <label>Step 3 processing time</label>
            <div class="input-with-unit">
              <input id="ptS3" type="number" step="any" placeholder="e.g., 1.5">
              <select id="ptS3Unit">
                <option value="seconds">seconds / unit</option>
                <option value="minutes" selected>minutes / unit</option>
                <option value="hours">hours / unit</option>
                <option value="days">days / unit</option>
              </select>
            </div>
            <div style="margin-top:8px;">
              <label for="mS3">Step 3 servers (m)</label>
              <input id="mS3" type="number" step="1" min="0" value="1">
            </div>
          </div>

          <div>
            <label>Step 4 processing time</label>
            <div class="input-with-unit">
              <input id="ptS4" type="number" step="any" placeholder="e.g., 4">
              <select id="ptS4Unit">
                <option value="seconds">seconds / unit</option>
                <option value="minutes" selected>minutes / unit</option>
                <option value="hours">hours / unit</option>
                <option value="days">days / unit</option>
              </select>
            </div>
            <div style="margin-top:8px;">
              <label for="mS4">Step 4 servers (m)</label>
              <input id="mS4" type="number" step="1" min="0" value="1">
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top: 12px;">
          <div>
            <label>Demand rate</label>
            <div class="input-with-unit">
              <input id="demandS" type="number" step="any" placeholder="e.g., 20">
              <select id="demandSUnit">
                <option value="per minute">flow units / minute</option>
                <option value="per hour" selected>flow units / hour</option>
                <option value="per day">flow units / day</option>
              </select>
            </div>
          </div>

          <div>
            <label>&nbsp;</label>
            <div class="row">
              <button type="button" onclick="runCh3Multi()">Compute</button>
              <button type="button" onclick="resetCh3()">Reset</button>
            </div>
          </div>
        </div>

        <div style="margin-top: 12px;">
          <div class="small">Result</div>
          <div class="result" id="ch3MultiResult">-</div>
          <div class="small" id="ch3MultiConversions" style="margin-top:6px;"></div>
        </div>

      </div>
    </details>

    <!-- Visible footer copyright notice -->
    <div class="footer">
      <div>© 2026 Amir Fard Bahreini. All rights reserved.</div>
      <div>These course materials may not be reproduced, distributed, recorded, or shared without permission.</div>
    </div>
  </div>

<script>
  /* -------- Helpers -------- */
  function parseNum(id) {
    const v = document.getElementById(id).value;
    if (v === "" || v === null) return null;
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function formatResult(value, roundSelectId) {
    const roundEl = document.getElementById(roundSelectId);
    const roundMode = roundEl ? roundEl.value : "none";
    if (roundMode === "none") return String(value);

    const decimals = Number(roundMode);
    if (!Number.isFinite(decimals)) return String(value);

    return value.toFixed(decimals);
  }

  function setText(id, txt) { document.getElementById(id).textContent = txt; }
  function clearText(id) { document.getElementById(id).textContent = ""; }

  function isNonNegative(n) {
    return typeof n === "number" && Number.isFinite(n) && n >= 0;
  }

  function fillSelect(selectEl, options) {
    selectEl.innerHTML = "";
    for (const opt of options) {
      const o = document.createElement("option");
      o.value = opt.value;
      o.textContent = opt.label;
      selectEl.appendChild(o);
    }
  }

  /* -------- Expand/Collapse Controls -------- */
  function openAll() {
    document.querySelectorAll("details.calc").forEach(d => d.open = true);
  }
  function closeAll() {
    document.querySelectorAll("details.calc").forEach(d => d.open = false);
  }
  function resetAll() {
    clearExpr();
    resetLittle();
    resetCh3();
  }

  /* -------- General Calculator (Exam-Safe) -------- */
  function appendExpr(s) {
    const el = document.getElementById("expr");
    el.value = (el.value || "") + s;
    el.focus();
  }

  function backspaceExpr() {
    const el = document.getElementById("expr");
    el.value = (el.value || "").slice(0, -1);
    el.focus();
  }

  function clearExpr() {
    document.getElementById("expr").value = "";
    document.getElementById("exprResult").textContent = "-";
  }

  function computeExpr() {
    const raw = (document.getElementById("expr").value || "").trim();
    if (!raw) {
      document.getElementById("exprResult").textContent = "Enter an expression.";
      return;
    }

    // Only allow digits, whitespace, decimal points, parentheses, + - * / and %
    if (!/^[0-9+\-*/().%\s]+$/.test(raw)) {
      document.getElementById("exprResult").textContent = "Invalid characters.";
      return;
    }

    // Simple percent handling: "x%" -> "(x/100)"
    const transformed = raw.replace(/(\d+(\.\d+)?)\s*%/g, "($1/100)");

    try {
      // Safe-ish evaluation due to strict character whitelist above
      // eslint-disable-next-line no-new-func
      const val = Function(`"use strict"; return (${transformed});`)();
      if (!Number.isFinite(val)) {
        document.getElementById("exprResult").textContent = "Result undefined.";
        return;
      }
      document.getElementById("exprResult").textContent = String(val);
    } catch (e) {
      document.getElementById("exprResult").textContent = "Check your expression.";
    }
  }

  document.addEventListener("keydown", (e) => {
    const active = document.activeElement;
    if (active && active.id === "expr" && e.key === "Enter") {
      e.preventDefault();
      computeExpr();
    }
  });

  /* -------- Little’s Law (I = R * T) with unit conversion -------- */

  // Base time unit: hour
  const TIME_TO_HOURS = {
    "seconds": 1 / 3600,
    "minutes": 1 / 60,
    "hours": 1,
    "days": 24
  };

  // Convert a rate "per X" into "per hour"
  const RATE_TO_PER_HOUR = {
    "per second": 3600,
    "per minute": 60,
    "per hour": 1,
    "per day": 1 / 24
  };

  function setUnitModeForSolveI() {
    const xUnit = document.getElementById("xUnit");
    const yUnit = document.getElementById("yUnit");

    fillSelect(xUnit, [
      { value: "per hour", label: "flow units per hour" },
      { value: "per minute", label: "flow units per minute" },
      { value: "per day", label: "flow units per day" }
    ]);

    fillSelect(yUnit, [
      { value: "seconds", label: "seconds" },
      { value: "minutes", label: "minutes" },
      { value: "hours", label: "hours" },
      { value: "days", label: "days" }
    ]);

    xUnit.value = "per hour";
    yUnit.value = "hours";

    document.getElementById("xUnitLabel").textContent = "Rate units";
    document.getElementById("yUnitLabel").textContent = "Time units";
  }

  function setUnitModeForSolveT() {
    const xUnit = document.getElementById("xUnit");
    const yUnit = document.getElementById("yUnit");

    fillSelect(xUnit, [
      { value: "flow units", label: "flow units" }
    ]);

    fillSelect(yUnit, [
      { value: "per hour", label: "flow units per hour" },
      { value: "per minute", label: "flow units per minute" },
      { value: "per day", label: "flow units per day" }
    ]);

    xUnit.value = "flow units";
    yUnit.value = "per hour";

    document.getElementById("xUnitLabel").textContent = "Inventory units";
    document.getElementById("yUnitLabel").textContent = "Rate units";
  }

  function setUnitModeForSolveR() {
    const xUnit = document.getElementById("xUnit");
    const yUnit = document.getElementById("yUnit");

    fillSelect(xUnit, [
      { value: "flow units", label: "flow units" }
    ]);

    fillSelect(yUnit, [
      { value: "seconds", label: "seconds" },
      { value: "minutes", label: "minutes" },
      { value: "hours", label: "hours" },
      { value: "days", label: "days" }
    ]);

    xUnit.value = "flow units";
    yUnit.value = "hours";

    document.getElementById("xUnitLabel").textContent = "Inventory units";
    document.getElementById("yUnitLabel").textContent = "Time units";
  }

  function setOutputUnitMode(mode) {
    const wrap = document.getElementById("outUnitWrap");
    const outUnitLabel = document.getElementById("outUnitLabel");
    const outUnit = document.getElementById("outUnit");

    if (mode === "solveI") {
      wrap.style.display = "none";
      outUnit.innerHTML = "";
      return;
    }

    wrap.style.display = "block";

    if (mode === "solveT") {
      outUnitLabel.textContent = "Output time units";
      fillSelect(outUnit, [
        { value: "seconds", label: "seconds" },
        { value: "minutes", label: "minutes" },
        { value: "hours", label: "hours" },
        { value: "days", label: "days" }
      ]);
      outUnit.value = "hours";
      return;
    }

    if (mode === "solveR") {
      outUnitLabel.textContent = "Output rate units";
      fillSelect(outUnit, [
        { value: "per minute", label: "flow units per minute" },
        { value: "per hour", label: "flow units per hour" },
        { value: "per day", label: "flow units per day" }
      ]);
      outUnit.value = "per hour";
      return;
    }
  }

  function updateLittleUI() {
    const mode = document.getElementById("modeLittle").value;

    const xLabel = document.getElementById("xLabel");
    const yLabel = document.getElementById("yLabel");
    const xInput = document.getElementById("xInput");
    const yInput = document.getElementById("yInput");

    xInput.value = "";
    yInput.value = "";
    setText("littleResult", "-");
    clearText("littleConversions");

    setOutputUnitMode(mode);

    if (mode === "solveI") {
      xLabel.textContent = "Flow rate, R";
      yLabel.textContent = "Flow time, T";
      xInput.placeholder = "e.g., 4";
      yInput.placeholder = "e.g., 30";
      setUnitModeForSolveI();
    }

    if (mode === "solveT") {
      xLabel.textContent = "Inventory, I (average inventory in system)";
      yLabel.textContent = "Flow rate, R";
      xInput.placeholder = "e.g., 200";
      yInput.placeholder = "e.g., 4";
      setUnitModeForSolveT();
    }

    if (mode === "solveR") {
      xLabel.textContent = "Inventory, I (average inventory in system)";
      yLabel.textContent = "Flow time, T";
      xInput.placeholder = "e.g., 200";
      yInput.placeholder = "e.g., 2";
      setUnitModeForSolveR();
    }
  }

  function runLittle() {
    const mode = document.getElementById("modeLittle").value;
    const x = parseNum("xInput");
    const y = parseNum("yInput");

    if (x === null || y === null) {
      setText("littleResult", "Enter both inputs.");
      clearText("littleConversions");
      return;
    }

    if (!isNonNegative(x) || !isNonNegative(y)) {
      setText("littleResult", "Inputs must be non-negative numbers.");
      clearText("littleConversions");
      return;
    }

    const xUnit = document.getElementById("xUnit").value;
    const yUnit = document.getElementById("yUnit").value;
    const outUnit = document.getElementById("outUnit").value;

    let conversionsNote = "";

    if (mode === "solveI") {
      const R_per_hour = x * (RATE_TO_PER_HOUR[xUnit] ?? 1);
      const T_hours = y * (TIME_TO_HOURS[yUnit] ?? 1);

      const I = R_per_hour * T_hours;

      const shown = formatResult(I, "roundLittle");
      setText("littleResult", "I = " + shown + " flow units");
      conversionsNote = `Converted to base units: R = ${R_per_hour} flow units/hour, T = ${T_hours} hours.`;
      setText("littleConversions", conversionsNote);
      return;
    }

    if (mode === "solveT") {
      const I = x;
      const R_per_hour = y * (RATE_TO_PER_HOUR[yUnit] ?? 1);

      if (R_per_hour === 0) {
        setText("littleResult", "Flow rate R must be > 0.");
        clearText("littleConversions");
        return;
      }

      const T_hours = I / R_per_hour;

      const factor = TIME_TO_HOURS[outUnit] ?? 1;
      const T_out = T_hours / factor;

      const shown = formatResult(T_out, "roundLittle");
      setText("littleResult", "T = " + shown + " " + outUnit);
      conversionsNote = `Converted to base units: R = ${R_per_hour} flow units/hour, so T = ${T_hours} hours.`;
      setText("littleConversions", conversionsNote);
      return;
    }

    if (mode === "solveR") {
      const I = x;
      const T_hours = y * (TIME_TO_HOURS[yUnit] ?? 1);

      if (T_hours === 0) {
        setText("littleResult", "Flow time T must be > 0.");
        clearText("littleConversions");
        return;
      }

      const R_per_hour = I / T_hours;

      const perHourFactor = RATE_TO_PER_HOUR[outUnit] ?? 1;
      const R_out = R_per_hour / perHourFactor;

      let label = "flow units/hour";
      if (outUnit === "per minute") label = "flow units/minute";
      if (outUnit === "per day") label = "flow units/day";

      const shown = formatResult(R_out, "roundLittle");
      setText("littleResult", "R = " + shown + " " + label);
      conversionsNote = `Converted to base units: T = ${T_hours} hours, so R = ${R_per_hour} flow units/hour.`;
      setText("littleConversions", conversionsNote);
      return;
    }
  }

  function resetLittle() {
    document.getElementById("modeLittle").value = "solveI";
    document.getElementById("roundLittle").value = "none";
    updateLittleUI();
  }

  /* -------- Chapter 3: Process Analysis -------- */

  function rateLabelFromUnit(outUnit) {
    if (outUnit === "per minute") return "flow units/minute";
    if (outUnit === "per day") return "flow units/day";
    return "flow units/hour";
  }

  function toPerHour(value, perUnit) {
    return value * (RATE_TO_PER_HOUR[perUnit] ?? 1);
  }

  function fromPerHour(valuePerHour, outPerUnit) {
    const factor = RATE_TO_PER_HOUR[outPerUnit] ?? 1;
    return valuePerHour / factor;
  }

  function cycleTimeOutFromHoursPerUnit(hoursPerUnit, outTimeUnit) {
    const factor = TIME_TO_HOURS[outTimeUnit] ?? 1;
    return hoursPerUnit / factor;
  }

  function safeIntOrDefault(n, defVal) {
    if (n === null || n === undefined || n === "") return defVal;
    const x = Number(n);
    if (!Number.isFinite(x) || x < 0) return defVal;
    return x;
  }

  function computeCapacityPerHour(processTimeVal, processTimeUnit, mVal) {
    const pt_hours_per_unit = processTimeVal * (TIME_TO_HOURS[processTimeUnit] ?? 1);
    if (pt_hours_per_unit <= 0) return null;
    const m = safeIntOrDefault(mVal, 1);
    return m / pt_hours_per_unit;
  }

  function runCh3Single() {
    const pt = parseNum("pt1");
    const demand = parseNum("demand1");
    const m = parseNum("m1");

    if (pt === null || demand === null) {
      setText("ch3SingleResult", "Enter processing time and demand rate.");
      clearText("ch3SingleConversions");
      return;
    }
    if (!isNonNegative(pt) || !isNonNegative(demand)) {
      setText("ch3SingleResult", "Inputs must be non-negative numbers.");
      clearText("ch3SingleConversions");
      return;
    }

    const ptUnit = document.getElementById("pt1Unit").value;
    const demandUnit = document.getElementById("demand1Unit").value;

    const outRateUnit = document.getElementById("outRateUnitCh3").value;
    const outTimeUnit = document.getElementById("outTimeUnitCh3").value;

    const cap_per_hour = computeCapacityPerHour(pt, ptUnit, m);
    if (cap_per_hour === null) {
      setText("ch3SingleResult", "Processing time must be > 0.");
      clearText("ch3SingleConversions");
      return;
    }

    const demand_per_hour = toPerHour(demand, demandUnit);
    const flow_per_hour = Math.min(cap_per_hour, demand_per_hour);

    const util = cap_per_hour === 0 ? 0 : (flow_per_hour / cap_per_hour);
    const cycle_hours_per_unit = flow_per_hour === 0 ? Infinity : (1 / flow_per_hour);

    const cap_out = fromPerHour(cap_per_hour, outRateUnit);
    const flow_out = fromPerHour(flow_per_hour, outRateUnit);
    const cycle_out = cycleTimeOutFromHoursPerUnit(cycle_hours_per_unit, outTimeUnit);

    const shownCap = formatResult(cap_out, "roundCh3");
    const shownFlow = formatResult(flow_out, "roundCh3");
    const shownUtil = (cycle_hours_per_unit === Infinity) ? "N/A" : formatResult(util, "roundCh3");
    const shownCycle = (cycle_hours_per_unit === Infinity) ? "N/A" : formatResult(cycle_out, "roundCh3");

    const rateLabel = rateLabelFromUnit(outRateUnit);

    setText(
      "ch3SingleResult",
      `Capacity = ${shownCap} ${rateLabel} | Flow rate = ${shownFlow} ${rateLabel} | Utilization = ${shownUtil} | Cycle time = ${shownCycle} ${outTimeUnit}/unit`
    );

    setText(
      "ch3SingleConversions",
      `Base units: capacity = ${cap_per_hour} flow units/hour, demand = ${demand_per_hour} flow units/hour, flow rate = ${flow_per_hour} flow units/hour.`
    );
  }

  function readStep(stepIdx) {
    const ptId = `ptS${stepIdx}`;
    const unitId = `ptS${stepIdx}Unit`;
    const mId = `mS${stepIdx}`;

    const pt = parseNum(ptId);
    if (pt === null) return null;

    if (!isNonNegative(pt)) return { error: "Processing times must be non-negative." };

    const unit = document.getElementById(unitId).value;
    const m = parseNum(mId);
    const cap = computeCapacityPerHour(pt, unit, m);

    if (cap === null) return { error: "Processing time must be > 0 for entered steps." };

    return { pt, unit, m: safeIntOrDefault(m, 1), cap_per_hour: cap };
  }

  function runCh3Multi() {
    const demand = parseNum("demandS");
    if (demand === null) {
      setText("ch3MultiResult", "Enter demand rate.");
      clearText("ch3MultiConversions");
      return;
    }
    if (!isNonNegative(demand)) {
      setText("ch3MultiResult", "Demand must be a non-negative number.");
      clearText("ch3MultiConversions");
      return;
    }

    const demandUnit = document.getElementById("demandSUnit").value;
    const outRateUnit = document.getElementById("outRateUnitCh3").value;
    const outTimeUnit = document.getElementById("outTimeUnitCh3").value;

    const steps = [];
    for (let i = 1; i <= 4; i++) {
      const s = readStep(i);
      if (s && s.error) {
        setText("ch3MultiResult", s.error);
        clearText("ch3MultiConversions");
        return;
      }
      if (s) steps.push({ idx: i, ...s });
    }

    if (steps.length === 0) {
      setText("ch3MultiResult", "Enter at least one step processing time.");
      clearText("ch3MultiConversions");
      return;
    }

    const processCap_per_hour = Math.min(...steps.map(s => s.cap_per_hour));
    const demand_per_hour = toPerHour(demand, demandUnit);
    const flow_per_hour = Math.min(processCap_per_hour, demand_per_hour);

    const cycle_hours_per_unit = flow_per_hour === 0 ? Infinity : (1 / flow_per_hour);

    const processCap_out = fromPerHour(processCap_per_hour, outRateUnit);
    const flow_out = fromPerHour(flow_per_hour, outRateUnit);
    const cycle_out = cycleTimeOutFromHoursPerUnit(cycle_hours_per_unit, outTimeUnit);

    const rateLabel = rateLabelFromUnit(outRateUnit);

    const perStepParts = steps.map(s => {
      const cap_i_out = fromPerHour(s.cap_per_hour, outRateUnit);
      const util_i = s.cap_per_hour === 0 ? 0 : (flow_per_hour / s.cap_per_hour);
      const capShown = formatResult(cap_i_out, "roundCh3");
      const utilShown = (cycle_hours_per_unit === Infinity) ? "N/A" : formatResult(util_i, "roundCh3");
      return `Step ${s.idx}: cap=${capShown} ${rateLabel}, util=${utilShown}`;
    }).join(" | ");

    const shownProcCap = formatResult(processCap_out, "roundCh3");
    const shownFlow = formatResult(flow_out, "roundCh3");
    const shownCycle = (cycle_hours_per_unit === Infinity) ? "N/A" : formatResult(cycle_out, "roundCh3");

    setText(
      "ch3MultiResult",
      `Process capacity = ${shownProcCap} ${rateLabel} | Flow rate = ${shownFlow} ${rateLabel} | Cycle time = ${shownCycle} ${outTimeUnit}/unit | ${perStepParts}`
    );

    setText(
      "ch3MultiConversions",
      `Base units: process capacity = ${processCap_per_hour} flow units/hour, demand = ${demand_per_hour} flow units/hour, flow rate = ${flow_per_hour} flow units/hour.`
    );
  }

  function resetCh3() {
    document.getElementById("pt1").value = "";
    document.getElementById("pt1Unit").value = "minutes";
    document.getElementById("m1").value = "1";
    document.getElementById("demand1").value = "";
    document.getElementById("demand1Unit").value = "per hour";

    for (let i = 1; i <= 4; i++) {
      document.getElementById(`ptS${i}`).value = "";
      document.getElementById(`ptS${i}Unit`).value = "minutes";
      document.getElementById(`mS${i}`).value = "1";
    }
    document.getElementById("demandS").value = "";
    document.getElementById("demandSUnit").value = "per hour";

    setText("ch3SingleResult", "-");
    clearText("ch3SingleConversions");
    setText("ch3MultiResult", "-");
    clearText("ch3MultiConversions");
  }

  /* -------- Accordion behavior (only one open at a time) -------- */
  document.querySelectorAll("details.calc").forEach(d => {
    d.addEventListener("toggle", () => {
      if (d.open) {
        document.querySelectorAll("details.calc").forEach(other => {
          if (other !== d) other.open = false;
        });
      }
    });
  });

  /* Initialize */
  updateLittleUI();
</script>
</body>
</html>
